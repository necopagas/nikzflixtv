import{r as e}from"./vendor-react-BqCNLigP.js";import{f as t,d as r}from"./index-Y1OpAnun.js";import{f as a}from"./Poster-B5VboZT4.js";import{A as s}from"./config-BJKyA3im.js";const n=()=>{const{watchedHistory:n}=t(),{myList:i}=r(),[l,c]=e.useState({becauseYouWatched:[],basedOnGenres:[],trending:[],similar:[],forYou:[]}),[o,u]=e.useState(!1),[d,m]=e.useState(null),h=e.useMemo(()=>n.length>0,[n.length]),f=e.useMemo(()=>i.length>0,[i.length]),g=e.useCallback(async()=>{if(0===n.length)return[];const e={},t=n.slice(-20);for(const n of t)try{const[t,r]=await Promise.all([a(s.details("movie",n)).catch(()=>null),a(s.details("tv",n)).catch(()=>null)]),i=t?.id?t:r;if(!i?.genres)continue;i.genres.forEach(t=>{e[t.id]=(e[t.id]||0)+1})}catch(r){}return Object.entries(e).sort(([,e],[,t])=>t-e).map(([e])=>parseInt(e))},[n]),y=e.useCallback(async()=>{if(0===n.length)return[];const e=n[n.length-1];try{const[t,r]=await Promise.all([a(s.details("movie",e)).catch(()=>null),a(s.details("tv",e)).catch(()=>null)]),n=t?.id?t:r,i=t?.id?"movie":"tv";if(!n)return[];m(n);return((await a(s.recommendations(i,e))).results||[]).slice(0,15)}catch(t){return[]}},[n]),p=e.useCallback(async()=>{const e=await g();if(0===e.length)return[];try{const t=e.slice(0,3).map(e=>a(s.byGenre(e)).then(e=>e.results||[]).catch(()=>[])),r=(await Promise.all(t)).flat(),i=Array.from(new Map(r.map(e=>[e.id,e])).values());return i.filter(e=>!n.includes(e.id.toString())).sort((e,t)=>{const r=.6*(e.vote_average||0)+.4*(e.popularity||0);return.6*(t.vote_average||0)+.4*(t.popularity||0)-r}).slice(0,20)}catch(t){return[]}},[g,n]),v=e.useCallback(async()=>{try{const e=(await a(s.trending)).results||[];if(n.length>0){const t=await g();return e.filter(e=>!e.genre_ids||e.genre_ids.some(e=>t.includes(e))).slice(0,15)}return e.slice(0,15)}catch(e){return[]}},[n,g]),w=e.useCallback(async()=>{if(0===i.length)return[];try{const e=i.slice(0,3).map(async e=>{const t=e.media_type||(e.first_air_date?"tv":"movie");try{return(await a(s.recommendations(t,e.id))).results||[]}catch{return[]}}),t=(await Promise.all(e)).flat();return Array.from(new Map(t.map(e=>[e.id,e])).values()).filter(e=>!n.includes(e.id.toString())).slice(0,15)}catch(e){return[]}},[i,n]),b=e.useCallback(async()=>{try{const[e,t]=await Promise.all([a(s.popular),a(s.toprated)]),r=[...e.results||[],...t.results||[]],i=Array.from(new Map(r.map(e=>[e.id,e])).values()).filter(e=>!n.includes(e.id.toString()));if(n.length>0){const e=await g();return i.map(t=>{const r=t.genre_ids?t.genre_ids.filter(t=>e.includes(t)).length/t.genre_ids.length:0,a=.3*(t.vote_average||0)+.2*(t.popularity||0)+10*r*.5;return{...t,score:a}}).sort((e,t)=>t.score-e.score).slice(0,20)}return i.sort((e,t)=>(t.vote_average||0)-(e.vote_average||0)).slice(0,20)}catch(e){return[]}},[n,g]);return e.useEffect(()=>{let e,t=!0;return(async()=>{if(0===n.length)return u(!1),void c({becauseYouWatched:[],basedOnGenres:[],trending:[],similar:[],forYou:[]});u(!0),e=setTimeout(()=>{t&&u(!1)},15e3);try{const[r,a,s,n,i]=await Promise.all([y(),p(),v(),w(),b()]);if(!t)return;clearTimeout(e),c({becauseYouWatched:r,basedOnGenres:a,trending:s,similar:n,forYou:i})}catch(r){}finally{t&&u(!1)}})(),()=>{t=!1,e&&clearTimeout(e)}},[n.length,i.length]),{recommendations:l,loading:o,sourceItem:d,hasWatchHistory:h,hasMyList:f}};export{n as u};
