import{r as e,j as t}from"./vendor-react-BqCNLigP.js";import{H as r,E as n,s as a}from"./vendor-players-DUwgxdJ7.js";import{X as s,Y as l,Z as i,$ as o,a0 as c,a1 as u,a as d,a2 as m,N as p,O as h,a3 as f,a4 as g,a5 as y,a6 as b,a7 as x,c as v}from"./vendor-react-ui-CyuwbvWU.js";import{I as w}from"./config-zXXe5B0b.js";import{v as k,c as N,d as j,a as S,w as C,x as E}from"./vendor-firebase-D_MHdhg9.js";import{l as A}from"./index-BGD4uCZd.js";import"./vendor-state-9eBMMYdn.js";import"./vendor-router-C4M7CORf.js";const q=e=>e?Object.entries(e).reduce((e,[t,r])=>(t&&null!=r&&(e[t]=String(r)),e),{}):{},L=e=>{try{const t=String(e||"").replace(/\s/g,""),r=("undefined"!=typeof window&&"function"==typeof window.atob?window.atob:"function"==typeof atob?atob:e=>{const t="undefined"!=typeof globalThis?globalThis.Buffer:void 0;if(t?.from)return t.from(e,"base64").toString("binary");throw new Error("No base64 decoder available")})(t),n=new Uint8Array(r.length);for(let e=0;e<r.length;e+=1)n[e]=r.charCodeAt(e);return n}catch(t){return null}},T=e=>{const t=L(e);return t?Array.from(t).map(e=>e.toString(16).padStart(2,"0")).join(""):null},P="/api/proxy?url=",I=(e="")=>"string"==typeof e&&e.includes(P),_=e=>(!e||I(e),e),R=(e,t="")=>{if(!I(e))return e||t;const r=e.indexOf(P);if(-1===r)return t;const n=e.slice(r+15);try{return decodeURIComponent(n)}catch(a){return t}},M=[".m3u8","format=m3u8","format=hls","playlist.m3u","hls/","manifest.m3u8","output.m3u8"],U=[".mpd","manifest.mpd","format=mpd","dash/","manifest=mpd",".ism/manifest","manifest.mpd?"],O=/\.(mp4|m4v|mov|webm|ogg|ogv|mkv|avi|ts)$/i,D=e=>{if(!e)return"unknown";const t=e.toLowerCase();return M.some(e=>t.includes(e))?"hls":U.some(e=>t.includes(e))?"dash":O.test(t)?"progressive":"unknown"},$=({channel:y,isLoading:b,onCanPlay:x,onError:v})=>{const w=e.useRef(null),k=e.useRef(null),N=e.useRef(null),j=e.useRef(null),S=e.useRef(null),C=e.useRef(null),E=e.useRef(null),A=e.useRef(new Set),P=e.useRef(null),[M,U]=e.useState(!1),[O,$]=e.useState(!1),[B,z]=e.useState(!1),[F,H]=e.useState([]),[K,G]=e.useState("Auto"),[V,J]=e.useState(null),[Y,W]=e.useState(0),[Q,X]=e.useState(0),[Z,ee]=e.useState(!1),[te,re]=e.useState(!1),[ne,ae]=e.useState(!1),[se,le]=e.useState(!1),[ie,oe]=e.useState(1),[ce,ue]=e.useState(1),[de,me]=e.useState(!1),[pe,he]=e.useState(!1),[fe,ge]=e.useState("undefined"!=typeof window&&window.innerWidth<768),ye=e.useCallback(e=>{const t=e||w.current;return t?t.play().catch(e=>t.muted?Promise.reject(e):(t.muted=!0,le(!0),t.play().catch(e=>Promise.reject(e)))):Promise.resolve()},[le]),be=e.useCallback(()=>{const e=S.current;!document.fullscreenElement&&e?.requestFullscreen?(e.requestFullscreen().catch(()=>{}),re(!0)):document.exitFullscreen&&(document.exitFullscreen().catch(()=>{}),re(!1))},[]);e.useEffect(()=>{const e=w.current;if(!e)return;const t=()=>ae(!0),r=()=>ae(!1);return e.addEventListener("play",t),e.addEventListener("pause",r),()=>{e.removeEventListener("play",t),e.removeEventListener("pause",r)}},[]),e.useEffect(()=>{const e=()=>ge(window.innerWidth<768);return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),e.useEffect(()=>{const e=w.current;e&&(e.muted=se)},[se]),e.useEffect(()=>{const e=w.current;e&&(e.volume=ie)},[ie]),e.useEffect(()=>{const e=w.current;e&&(e.playbackRate=ce)},[ce]),e.useEffect(()=>{const e=()=>{re(!!document.fullscreenElement||!!document.webkitFullscreenElement)};return document.addEventListener("fullscreenchange",e),document.addEventListener("webkitfullscreenchange",e),()=>{document.removeEventListener("fullscreenchange",e),document.removeEventListener("webkitfullscreenchange",e)}},[]);const xe=e.useCallback(()=>{const e=w.current;e&&(e.paused?e.play().catch(()=>{}):e.pause())},[]),ve=e.useCallback(()=>le(e=>!e),[]),we=e.useCallback(e=>{const t=w.current;t&&(t.currentTime=Math.max(0,Math.min(t.duration||0,t.currentTime+e)))},[]),ke=e.useCallback(()=>{const e=w.current;if(!e)return;const t=e.textTracks||[];he(e=>{const r=!e;for(let n=0;n<t.length;n++)t[n].mode=r?"showing":"disabled";return r})},[]);e.useEffect(()=>{const e=S.current;if(!e)return;const t=e=>{const t=document.activeElement;t&&("INPUT"===t.tagName||"TEXTAREA"===t.tagName||t.isContentEditable)||("Space"===e.code?(e.preventDefault(),xe()):"ArrowLeft"===e.key?(e.preventDefault(),we(-5)):"ArrowRight"===e.key?(e.preventDefault(),we(5)):"ArrowUp"===e.key?(e.preventDefault(),oe(e=>Math.min(1,+(e+.05).toFixed(2)))):"ArrowDown"===e.key?(e.preventDefault(),oe(e=>Math.max(0,+(e-.05).toFixed(2)))):"m"===e.key.toLowerCase()?(e.preventDefault(),ve()):"f"===e.key.toLowerCase()?(e.preventDefault(),be()):"c"===e.key.toLowerCase()&&(e.preventDefault(),ke()))};return e.addEventListener("keydown",t),e.tabIndex=e.tabIndex??0,()=>e.removeEventListener("keydown",t)},[xe,we,ve,be,ke]),e.useEffect(()=>{let e;const t=()=>{U(!0),clearTimeout(e),e=setTimeout(()=>U(!1),4e3)},r=S.current;return r&&(r.addEventListener("mousemove",t),r.addEventListener("touchstart",t),t()),()=>{r&&(r.removeEventListener("mousemove",t),r.removeEventListener("touchstart",t)),clearTimeout(e)}},[]);const Ne=e.useCallback(()=>{if(C.current&&(clearTimeout(C.current),C.current=null),E.current){try{E.current()}catch(t){}E.current=null}if(k.current&&(k.current.destroy(),k.current=null),N.current&&("function"==typeof N.current.destroy?N.current.destroy():"function"==typeof N.current.reset&&N.current.reset(),N.current=null),j.current){try{const e=j.current.destroy?.();e?.catch&&e.catch(e=>{})}catch(t){}j.current=null}const e=w.current;e&&(e.removeAttribute("src"),e.load())},[]),je=e.useCallback(()=>{Ne();const e=w.current;if(!e||!y?.url)return void x?.();const t=y?.originalUrl||R(y.url,y.url),s=y?`${y?.name||"unknown"}::${y?.number||""}::${t}`:null;P.current!==s&&(P.current=s,A.current=new Set),A.current.add(y.url);const l=((e={})=>{const t=e.type||e.streamType||e.format||e.protocol||e.manifestType;if(!t)return null;const r=String(t).toLowerCase();return["dash","mpd","mpeg-dash","dashjs","dash/shaka","dash_shaka"].includes(r)?"dash":["hls","m3u8","application/x-mpegurl","hls.js"].includes(r)?"hls":["progressive","mp4","file","direct"].includes(r)?"progressive":null})(y),i=l?y.url:t,o=l||D(i),c=q(y?.headers),u=q(y?.hls?.headers||c),d=q(y?.dash?.headers||c),m=Boolean(y?.withCredentials),p=y?.hls?.withCredentials??m,h=y?.dash?.withCredentials??m;let f=null;const g=Math.max(4e3,Number(y?.playbackGuardMs)||8e3);let b=!1,S=!1;const M=()=>{if(C.current&&(clearTimeout(C.current),C.current=null),E.current){try{E.current()}catch(e){}E.current=null}},U=(e,r=null,n=0)=>{if(S)return;const a=[],s=new Set,l=(e,t)=>{if(!e)return;if(e===y.url)return;if(A.current.has(e))return;if(s.has(e))return;s.add(e);const r=D(t||R(e,e));a.push({url:e,type:r&&"unknown"!==r?r:void 0})},i=e=>{if(!e)return;l(e,e);const t=R(e,e);t&&t!==e&&l(t,t);const r=_(t);r&&l(r,t)};if(i(r),i(y?.fallback),i(y?.hls?.url),i(y?.dash?.fallback),i(y?.dash?.fallbackUrl),i(y?.streamFallback),i(y?.backupUrl),I(y.url))t&&t!==y.url&&l(t,t);else{const e=_(t);e&&l(e,t)}const o=a.find(Boolean);if(o){S=!0,M(),f&&(clearInterval(f),f=null),A.current.add(o.url);const e={url:o.url,originalUrl:t};o.type&&(e.type=o.type);const r=()=>v?.(e);n>0?setTimeout(r,n):r()}else S=!0,M(),f&&(clearInterval(f),f=null),v?.({url:null,originalUrl:t,reason:"no-fallback"}),x?.()},O=()=>{if(b)return;const e=w.current;if(!e)return;const t=(()=>{try{return e.buffered?.length&&e.buffered.end(e.buffered.length-1)-e.currentTime>.1}catch{return!1}})();e.readyState>=2&&!e.paused&&(e.currentTime>.2||t)&&(b=!0,M())},$=()=>{const e=w.current;if(!e)return;const t=()=>O(),r=()=>O(),n=()=>O(),a=()=>O();e.addEventListener("progress",t),e.addEventListener("playing",r),e.addEventListener("timeupdate",n),e.addEventListener("loadeddata",a),E.current=()=>{e.removeEventListener("progress",t),e.removeEventListener("playing",r),e.removeEventListener("timeupdate",n),e.removeEventListener("loadeddata",a)},C.current=setTimeout(()=>{b||S||(O(),b||S||U(y?.name||y.url))},g)};$();try{if("hls"===o)if(r.isSupported()){const t={enableWorker:!0,lowLatencyMode:!0,backBufferLength:y?.hls?.backBufferLength};(Object.keys(u).length>0||p)&&(t.xhrSetup=e=>{p&&(e.withCredentials=!0),Object.entries(u).forEach(([t,r])=>{try{e.setRequestHeader(t,r)}catch(n){}})},t.fetchSetup=(e,t)=>{const r={...t},n={...e?.headers||{},...t?.headers||{}};return Object.entries(u).forEach(([e,t])=>{n[e]=t}),Object.keys(n).length>0&&(r.headers=n),p&&(e.credentials="include",r.credentials="include"),e.headers=n,r});const n=y?.hls?.config?{...t,...y.hls.config}:t,a=new r(n);k.current=a,a.loadSource(y.url),a.attachMedia(e),a.on(r.Events.MANIFEST_PARSED,()=>{H([{label:"Auto",value:-1},...a.levels.map((e,t)=>({label:`${e.height}p`,value:t}))]),ye(e).then(()=>O()).catch(e=>{}),x?.()}),a.on(r.Events.LEVEL_SWITCHED,(e,t)=>{const r=a.levels[t.level];G(a.autoLevelEnabled?"Auto":`${r.height}p`),X(r?.bitrate||0)}),a.on(r.Events.ERROR,(e,t)=>{t.details?(t.type,t.details):t.type,t.fatal;t.fatal&&t.type===r.ErrorTypes.NETWORK_ERROR?U(y?.name||y.url,y.fallback):t.fatal&&U(y?.name||y.url,y.fallback,200)});f=setInterval(()=>{if(k.current){J(k.current.latency?.toFixed(1));try{const t=r.BufferHelper?.bufferInfo(e,e.currentTime,.5);W(t?.len?.toFixed(1)||"0.0")}catch{W("0.0")}}},1e3)}else e.canPlayType("application/vnd.apple.mpegurl")?(e.src=y.url,ye(e).then(()=>O()).catch(e=>{}),e.addEventListener("canplay",()=>x?.(),{once:!0}),e.addEventListener("error",()=>{U(y?.name||y.url,y.fallback)})):x?.();else if("dash"===o){let t=!1;const r=()=>{t=!0;try{const t=n().create();N.current=t,t.updateSettings({debug:{logLevel:4},streaming:{abr:{autoSwitchBitrate:{video:!0,audio:!0},limitBitrateByPortal:!0},buffer:{fastSwitchEnabled:!0,bufferTimeAtTopQuality:30,bufferTimeAtTopQualityLongForm:60,initialBufferLevel:10,stableBufferTime:20,bufferPruningInterval:10},gaps:{jumpGaps:!0,jumpLargeGaps:!0,smallGapLimit:1.5},retryAttempts:{MPD:10,XLinkExpansion:5,MediaSegment:10,InitializationSegment:10,BitstreamSwitching:5},retryIntervals:{MPD:1e3,XLinkExpansion:1e3,MediaSegment:1e3,InitializationSegment:1e3,BitstreamSwitching:1e3},lowLatencyEnabled:!1,liveCatchup:{enabled:!0}}}),y?.dash?.settings&&t.updateSettings(y.dash.settings),"function"==typeof y?.dash?.requestModifier?t.extend("RequestModifier",y.dash.requestModifier,!0):t.extend("RequestModifier",((e,t=!1)=>{const r=q(e);return function(){return{modifyRequestHeader:e=>(t&&(e.withCredentials=!0),Object.entries(r).forEach(([t,r])=>{try{e.setRequestHeader(t,r)}catch(n){}}),e),modifyRequestURL:e=>e}}})(d,h),!0),((e,t={})=>{if(!e||!t)return;const r={};if(t.widevine?.licenseUrl&&(r["com.widevine.alpha"]={serverURL:t.widevine.licenseUrl,httpRequestHeaders:q(t.widevine.headers)},t.widevine.serverCertificate)){const e=L(t.widevine.serverCertificate);e&&(r["com.widevine.alpha"].serverCertificate=e)}t.playready?.licenseUrl&&(r["com.microsoft.playready"]={serverURL:t.playready.licenseUrl,httpRequestHeaders:q(t.playready.headers)}),t.clearkey?.keys?.length&&(r["org.w3.clearkey"]={clearkeys:t.clearkey.keys.reduce((e,t)=>(t.kid&&t.k&&(e[t.kid]=t.k),e),{})}),Object.keys(r).length>0&&e.setProtectionData(r)})(t,y?.dash?.drm||y?.drm),t.initialize(e,y.url,!0),t.on(n.events.STREAM_INITIALIZED,()=>{const r=t.getBitrateInfoListFor("video");if(r?.length){const e=r.map((e,t)=>({label:`${e.height}p`,value:t,bitrate:e.bitrate}));H([{label:"Auto",value:-1},...e])}ye(e).then(()=>O()).catch(e=>{}),x?.()}),t.on(n.events.PLAYBACK_STARTED,()=>{ae(!0),O()}),t.on(n.events.QUALITY_CHANGE_RENDERED,e=>{if("video"===e.mediaType){const r=t.getBitrateInfoListFor("video"),n=r?.[e.newQuality];n&&(G(t.getSettings().streaming.abr.autoSwitchBitrate.video?"Auto":`${n.height}p`),X(n.bitrate||0))}}),t.on(n.events.ERROR,e=>{U(y?.name||y.url,y.fallback,400)});return f=setInterval(()=>{if(!S&&N.current&&e){if(N.current.getMetricsFor("video")){const e=N.current.getDashMetrics(),t=e?.getCurrentBufferLevel("video");void 0!==t&&W(t.toFixed(1))}if("function"==typeof N.current.getCurrentLiveLatency){const e=N.current.getCurrentLiveLatency();"number"!=typeof e||Number.isNaN(e)||J(e.toFixed(1))}const e="function"==typeof N.current.getQualityFor?N.current.getQualityFor("video"):null,t=N.current.getBitrateInfoListFor?.("video");Array.isArray(t)&&"number"==typeof e&&t[e]&&X(t[e].bitrate||0)}},1e3),!0}catch(r){return U(y?.name||y.url,y.fallback),!1}};(()=>{if(void 0===a||!a.Player||!a.Player.isBrowserSupported())return!1;try{a.polyfill?.installAll?.();const n=new a.Player(e);j.current=n,n.configure({streaming:{rebufferingGoal:10,bufferingGoal:20,lowLatencyMode:!1,jumpLargeGaps:!0},abr:{enabled:!0,defaultBandwidthEstimate:5e6}}),y?.dash?.shakaConfig&&n.configure(y.dash.shakaConfig);const s=y?.dash?.drm||y?.drm,l=((e={})=>{if(!e||"object"!=typeof e)return null;const t={},r={},n={};let a=null;if(e.widevine?.licenseUrl){t["com.widevine.alpha"]=e.widevine.licenseUrl;const a=q(e.widevine.headers);if(Object.keys(a).length>0&&(n["com.widevine.alpha"]=a),e.widevine.serverCertificate){const t=L(e.widevine.serverCertificate);t&&(r["com.widevine.alpha"]={serverCertificate:t})}}if(e.playready?.licenseUrl){t["com.microsoft.playready"]=e.playready.licenseUrl;const r=q(e.playready.headers);Object.keys(r).length>0&&(n["com.microsoft.playready"]=r)}return e.clearkey?.keys?.length&&(a=e.clearkey.keys.reduce((e,t)=>{if(!t?.kid||!t?.k)return e;const r=/[^a-f0-9]/i.test(t.kid)?T(t.kid):t.kid.toLowerCase(),n=/[^a-f0-9]/i.test(t.k)?T(t.k):t.k.toLowerCase();return r&&n&&(e[r]=n),e},{})),0!==Object.keys(t).length||a?{servers:t,advanced:r,licenseHeaders:n,clearKeys:a}:null})(s),i={};if(l){const e={};l.servers&&Object.keys(l.servers).length&&(e.servers=l.servers),l.advanced&&Object.keys(l.advanced).length&&(e.advanced=l.advanced),l.clearKeys&&Object.keys(l.clearKeys).length&&(e.clearKeys=l.clearKeys),Object.keys(e).length&&n.configure({drm:e}),Object.values(l.licenseHeaders||{}).forEach(e=>{Object.assign(i,e)})}const o=n.getNetworkingEngine?.();if(o){const e=a.net.NetworkingEngine.RequestType,t=new Set([e.MANIFEST,e.SEGMENT,e.SEGMENT_LIST,e.TIMELINE,e.SEGMENT_INIT,e.APP_MANIFEST]);o.clearAllRequestFilters?.(),o.registerRequestFilter((r,n)=>{const a=n.headers||(n.headers={});(h||s?.withCredentials)&&(n.allowCrossSiteCredentials=!0),t.has(r)&&Object.keys(d).length>0&&Object.assign(a,d),r===e.LICENSE&&Object.keys(i).length>0&&Object.assign(a,i)})}const c=e=>{if(!S){if(f&&(clearInterval(f),f=null),!t){Ne(),M(),$();return void(r()||U(y?.name||y.url,y.fallback,500))}U(y?.name||y.url,y.fallback,500)}};n.addEventListener("error",e=>{const t=e?.detail||e,r=t?.severity;"number"==typeof r&&a.util?.Error?.Severity&&r!==a.util.Error.Severity.CRITICAL||c(t)}),n.addEventListener("adaptation",()=>{const e=(n.getVariantTracks?.()||[]).find(e=>e.active),t=n.getConfiguration().abr.enabled;e&&(G(t?"Auto":`${e.height||Math.round((e.bandwidth||0)/1e3)}p`),X(e.bandwidth||0),O())}),n.load(y.url).then(()=>{const t=n.getVariantTracks?.()||[],r=new Set,a=t.filter(e=>"variant"===e.type&&e.height).filter(e=>{const t=`${e.height}-${e.bandwidth}`;return!r.has(t)&&(r.add(t),!0)}).sort((e,t)=>(e.height||0)-(t.height||0)).map((e,t)=>({label:`${e.height}p`,value:e.id??t,trackId:e.id,bandwidth:e.bandwidth,height:e.height}));H([{label:"Auto",value:-1},...a]),ye(e).then(()=>O()).catch(e=>{}),x?.()}).catch(e=>{c(e)});return f=setInterval(()=>{if(S)return;if(!j.current||!e)return;const t=e.buffered;if(t?.length){const r=t.end(t.length-1)-e.currentTime;Number.isNaN(r)||W(r.toFixed(1))}const r=j.current.getPresentationLatency?.();"number"!=typeof r||Number.isNaN(r)||J(r.toFixed(1));const n=j.current.getStats?.();n?.estimatedBandwidth&&X(n.estimatedBandwidth)},1e3),!0}catch(n){return U(y?.name||y.url,y.fallback),!1}})()||r()}else"progressive"===o?(e.src=y.url,e.load(),ye(e).then(()=>O()).catch(e=>{}),e.addEventListener("canplay",()=>x?.(),{once:!0}),e.addEventListener("error",()=>{U(y?.name||y.url,y.fallback)})):x?.()}catch(B){x?.()}return()=>{f&&clearInterval(f)}},[y,Ne,x,v,ye]);e.useEffect(()=>{if(y?.url){ee(!0);let e=null,t=null;const r=setTimeout(()=>{e=je(),t=setTimeout(()=>{ee(!1)},300)},50);return()=>{clearTimeout(r),t&&clearTimeout(t),"function"==typeof e&&e(),Ne()}}Ne(),ee(!1),x?.()},[y,je,Ne,x]),e.useEffect(()=>Ne,[]);return t.jsxs("div",{ref:S,className:"relative bg-black rounded-lg overflow-hidden aspect-video group",children:[(b||Z)&&t.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/80 z-20 pointer-events-none",children:t.jsx("div",{className:"w-12 h-12 border-4 border-t-(--brand-color) border-gray-600 rounded-full animate-spin"})}),t.jsx("video",{ref:w,className:"w-full h-full block",playsInline:!0,autoPlay:!0,controls:!0}),t.jsxs("div",{className:"absolute inset-0 bg-linear-to-t from-black/70 via-transparent to-transparent transition-opacity duration-300 "+(M?"opacity-100":"opacity-0 pointer-events-none"),children:[t.jsx("div",{className:"absolute top-0 left-0 right-0 p-3 flex justify-end text-white z-10",children:t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:()=>z(e=>!e),"aria-pressed":B,"aria-label":B?"Hide stats":"Show stats",className:"p-2 rounded-full bg-black/50 hover:bg-white/20 transition-colors focus:outline-none focus:ring-2 focus:ring-(--brand-color)",title:"Show/Hide Stats",children:t.jsx(s,{className:"w-5 h-5"})}),document.pictureInPictureEnabled&&w.current&&!w.current.disablePictureInPicture&&t.jsx("button",{onClick:()=>w.current?.requestPictureInPicture().catch(e=>{}),"aria-label":"Picture in Picture",className:"p-2 rounded-full bg-black/50 hover:bg-white/20 transition-colors focus:outline-none focus:ring-2 focus:ring-(--brand-color)",title:"Picture-in-Picture",children:t.jsx(l,{className:"w-5 h-5"})}),t.jsx("button",{onClick:be,"aria-label":te?"Exit fullscreen":"Enter fullscreen",className:"p-2 rounded-full bg-black/50 hover:bg-white/20 transition-colors focus:outline-none focus:ring-2 focus:ring-(--brand-color)",title:te?"Exit Fullscreen":"Enter Fullscreen",children:te?t.jsx(i,{className:"w-5 h-5"}):t.jsx(o,{className:"w-5 h-5"})})]})}),t.jsxs("div",{className:"absolute bottom-0 left-0 right-0 p-3 text-white z-10",children:[t.jsxs("div",{className:"flex justify-between items-center mb-2",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("button",{onClick:()=>we(-10),"aria-label":"Rewind 10 seconds",className:"p-2 rounded-full bg-black/50 hover:bg-white/20 transition-colors focus:outline-none focus:ring-2 focus:ring-(--brand-color)",title:"Rewind 10s",children:t.jsx(c,{})}),t.jsx("button",{onClick:xe,"aria-pressed":ne,"aria-label":ne?"Pause":"Play",className:"p-2 rounded-full bg-black/50 hover:bg-white/20 transition-colors focus:outline-none focus:ring-2 focus:ring-(--brand-color)",title:ne?"Pause":"Play",children:ne?t.jsx(u,{}):t.jsx(d,{})}),t.jsx("button",{onClick:()=>we(10),"aria-label":"Forward 10 seconds",className:"p-2 rounded-full bg-black/50 hover:bg-white/20 transition-colors focus:outline-none focus:ring-2 focus:ring-(--brand-color)",title:"Forward 10s",children:t.jsx(m,{})}),t.jsxs("div",{className:"flex items-center gap-2 ml-2",children:[t.jsx("button",{onClick:ve,"aria-pressed":se,"aria-label":se?"Unmute":"Mute",className:"p-2 rounded-full bg-black/50 hover:bg-white/20 transition-colors focus:outline-none focus:ring-2 focus:ring-(--brand-color)",title:se?"Unmute":"Mute",children:se?t.jsx(p,{}):t.jsx(h,{})}),t.jsx("input",{"aria-label":"Volume",type:"range",min:"0",max:"1",step:"0.01",value:ie,onChange:e=>oe(parseFloat(e.target.value)),className:"w-24 focus:outline-none focus:ring-2 focus:ring-(--brand-color)"})]}),t.jsxs("h3",{className:"font-bold text-lg truncate max-w-[calc(100%-150px)]","aria-live":"polite",children:[y?.number?`#${y.number} `:"",y?.name||"No Channel Selected"]})]}),t.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[null!==V&&!isNaN(V)&&t.jsx("span",{className:"text-xs px-2 py-1 rounded "+(V<5?"bg-green-600":V<15?"bg-orange-600":"bg-red-600"),children:V<5?"LIVE":`Delay: ${V}s`}),F.length>1&&t.jsxs("button",{onClick:()=>$(e=>!e),"aria-expanded":O,"aria-haspopup":"menu","aria-label":`Quality ${K}`,className:"px-3 py-1 bg-white/20 hover:bg-white/30 rounded text-sm focus:outline-none focus:ring-2 focus:ring-(--brand-color)",children:[K," ",t.jsx("span",{className:"ml-1 text-xs",children:O?"â–¾":"â–´"})]}),t.jsxs("div",{className:"relative",children:[t.jsxs("button",{onClick:()=>me(e=>!e),"aria-expanded":de,"aria-haspopup":"menu","aria-label":`Playback speed ${ce}x`,className:"px-3 py-1 bg-white/20 hover:bg-white/30 rounded text-sm focus:outline-none focus:ring-2 focus:ring-(--brand-color)",children:[ce,"x"]}),de&&t.jsx("div",{className:"absolute right-0 bottom-10 bg-black/90 rounded p-2",children:[.5,.75,1,1.25,1.5,2].map(e=>t.jsxs("button",{onClick:()=>{ue(e),me(!1)},className:"block w-full text-left px-3 py-1 text-sm hover:bg-white/20 "+(ce===e?"text-(--brand-color) font-bold":""),children:[e,"x"]},e))})]}),t.jsx("button",{onClick:ke,"aria-pressed":pe,"aria-label":pe?"Disable captions":"Enable captions",className:"p-2 rounded-full bg-black/50 hover:bg-white/20 transition-colors focus:outline-none focus:ring-2 focus:ring-(--brand-color) "+(pe?"text-(--brand-color)":""),title:"Toggle Captions",children:t.jsx(f,{})})]})]}),O&&F.length>1&&t.jsx("div",{className:"absolute bottom-14 right-3 bg-black/90 rounded-lg p-2 min-w-[120px] max-h-48 overflow-y-auto z-50",role:"menu","aria-label":"Quality options",children:F.map(e=>t.jsx("button",{onClick:()=>(e=>{const t=F.find(t=>String(t.value)===String(e));if(t){if(k.current){const e=Number(t.value);k.current.currentLevel=e;const r=e>=0?k.current.levels?.[e]:null;r?.bitrate&&X(r.bitrate),G(-1===e?"Auto":t.label||`${r?.height||""}p`)}else if(N.current){const e=Number(t.value),r=N.current.getSettings();if(-1===e)r.streaming.abr.autoSwitchBitrate.video=!0,N.current.updateSettings(r),G("Auto");else{r.streaming.abr.autoSwitchBitrate.video=!1,N.current.updateSettings(r),N.current.setQualityFor("video",e),G(t.label||"...");const n=N.current.getBitrateInfoListFor?.("video"),a=n?.[e];a?.bitrate&&X(a.bitrate)}}else if(j.current)if(-1===t.value)j.current.configure({abr:{enabled:!0}}),G("Auto");else{j.current.configure({abr:{enabled:!1}});const e=(j.current.getVariantTracks?.()||[]).find(e=>String(e.id??e.height)===String(t.trackId??t.value));e&&(j.current.selectVariantTrack(e,!0,0),G(t.label||`${e.height||Math.round((e.bandwidth||0)/1e3)}p`),e.bandwidth&&X(e.bandwidth))}$(!1)}})(e.value),className:"block w-full text-left px-3 py-2 rounded hover:bg-white/20 text-sm transition-colors "+(K===e.label&&"Auto"!==e.label||"Auto"===K&&-1===e.value?"text-(--brand-color) font-bold":""),children:e.label},e.value))})]})]}),fe&&t.jsxs("div",{className:"absolute bottom-3 left-1/2 transform -translate-x-1/2 z-30 bg-black/60 rounded-full px-3 py-2 flex items-center gap-3 backdrop-blur-md",children:[t.jsx("button",{onClick:()=>we(-10),"aria-label":"Rewind 10 seconds",className:"p-2 rounded-full bg-black/40 hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-(--brand-color)",children:t.jsx(c,{})}),t.jsx("button",{onClick:xe,"aria-pressed":ne,"aria-label":ne?"Pause":"Play",className:"p-3 rounded-full bg-(--brand-color) text-black focus:outline-none focus:ring-2 focus:ring-white",children:ne?t.jsx(u,{}):t.jsx(d,{})}),t.jsx("button",{onClick:()=>we(10),"aria-label":"Forward 10 seconds",className:"p-2 rounded-full bg-black/40 hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-(--brand-color)",children:t.jsx(m,{})}),t.jsx("button",{onClick:ve,"aria-pressed":se,"aria-label":se?"Unmute":"Mute",className:"p-2 rounded-full bg-black/40 hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-(--brand-color)",children:se?t.jsx(p,{}):t.jsx(h,{})}),t.jsx("button",{onClick:be,"aria-label":te?"Exit fullscreen":"Enter fullscreen",className:"p-2 rounded-full bg-black/40 hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-(--brand-color)",children:t.jsx(o,{className:"w-5 h-5"})})]}),B&&t.jsxs("div",{className:"absolute top-4 left-4 bg-black/80 text-green-400 text-xs p-3 rounded font-mono space-y-1 z-20",children:[t.jsxs("p",{children:["Buffer: ",null===Y||isNaN(Y)?"N/A":`${Y}s`]}),t.jsxs("p",{children:["Bitrate: ",Q>0?`${(Q/1e3).toFixed(0)} kbps`:"N/A"]}),t.jsxs("p",{children:["Latency: ",null===V||isNaN(V)?"N/A":`${V}s`]}),t.jsx("button",{onClick:()=>z(!1),className:"absolute top-1 right-1 text-white hover:text-red-500",children:t.jsx(g,{className:"w-4 h-4"})})]})]})},B=e=>{const t=e.toLowerCase();return t.includes("gma")||t.includes("abs")||t.includes("inc tv")?"Local":t.includes("news")||t.includes("aljazeera")||t.includes("bloomberg")||t.includes("bbc news")||t.includes("sky news")?"News":t.includes("kids")||t.includes("disney")||t.includes("nickelodeon")||t.includes("nick jr")||t.includes("cartoon")||t.includes("baby")||t.includes("zoomoo")||t.includes("kidoodle")?"Kids":t.includes("anime")||t.includes("hi-yah")?"Anime":t.includes("nba")||t.includes("nhl")||t.includes("combat")||t.includes("redbull")||t.includes("sport")?"Sports":t.includes("mtv")||t.includes("music")||t.includes("hallypop")||t.includes("frontrow")?"Music":t.includes("discovery")||t.includes("nat geo")||t.includes("national geographic")||t.includes("animal planet")||t.includes("travel")||t.includes("wild earth")||t.includes("lotus")?"Documentary":t.includes("hbo")||t.includes("showtime")||t.includes("starz")||t.includes("cinemax")?"Premium":t.includes("movie")||t.includes("amc")||t.includes("scream")||t.includes("thriller")||t.includes("action")||t.includes("plex")||t.includes("samsung")?"Movies":t.includes("hgtv")||t.includes("food")||t.includes("travel")?"Lifestyle":"Entertainment"},z=(t=!0)=>{const[r,n]=e.useState(w),[a,s]=e.useState(!1),[l,i]=e.useState(null),[o,c]=e.useState("idle"),[u,d]=e.useState([]),m=async()=>{s(!0),c("syncing");try{const e=await(async()=>{try{const e=await fetch("https://raw.githubusercontent.com/aCoDenz/w5s/refs/heads/main/livetv/TVChannels.json");if(!e.ok)return null;const t=await e.json(),r=[];let n=1;for(const[a,s]of Object.entries(t))"#[ CHANNELS ]"!==a&&r.push({name:a,url:s.link,category:B(a),number:n++,source:"external"});return r}catch(e){return null}})();if(e){const t=((e,t)=>{if(!t)return{hasUpdates:!1,updates:[]};const r=[],n=new Map(t.map(e=>[e.name.toUpperCase(),e.url]));return e.forEach(e=>{const t=n.get(e.name.toUpperCase());t&&t!==e.url&&r.push({name:e.name,oldUrl:e.url,newUrl:t})}),{hasUpdates:r.length>0,updates:r,count:r.length}})(w,e);d(t.updates),t.hasUpdates;const r=((e,t)=>{if(!t)return e;const r=[...e],n=new Set(e.map(e=>e.name.toUpperCase()));return t.forEach(e=>{n.has(e.name.toUpperCase())||r.push({...e,number:r.length+1})}),r})(w,e);return n(r),i(new Date),c("success"),{success:!0,totalChannels:r.length,newChannels:r.length-w.length,updates:t.updates}}return n(w),c("error"),{success:!1,totalChannels:w.length,newChannels:0,updates:[]}}catch(e){return n(w),c("error"),{success:!1,error:e.message,totalChannels:w.length,newChannels:0,updates:[]}}finally{s(!1)}};return e.useEffect(()=>{if(t){const e=localStorage.getItem("iptv_last_sync"),t=36e5;!e||Date.now()-parseInt(e)>t?m().then(()=>{localStorage.setItem("iptv_last_sync",Date.now().toString())}):n(w)}else n(w)},[t]),{channels:r,isSyncing:a,lastSync:l,syncStatus:o,updates:u,syncChannels:m,hasUpdates:u.length>0}},F=async e=>{const t=(e=>{try{const t=localStorage.getItem(`channel_health_${btoa(e)}`);if(!t)return null;const r=JSON.parse(t);return Date.now()-r.timestamp>3e5?(localStorage.removeItem(`channel_health_${btoa(e)}`),null):r.health}catch{return null}})(e);if(t)return{...t,fromCache:!0};const r=await(async(e,t=5e3)=>{const r=performance.now();try{const n=new AbortController,a=setTimeout(()=>n.abort(),t);return await fetch(e,{method:"HEAD",signal:n.signal,mode:"no-cors"}),clearTimeout(a),{isAlive:!0,latency:Math.round(performance.now()-r),error:null,status:"online"}}catch(n){const e=Math.round(performance.now()-r);return"AbortError"===n.name?{isAlive:!1,latency:e,error:"Timeout",status:"timeout"}:{isAlive:!1,latency:e,error:n.message,status:"offline"}}})(e);return((e,t)=>{try{const r={health:t,timestamp:Date.now()};localStorage.setItem(`channel_health_${btoa(e)}`,JSON.stringify(r))}catch(r){}})(e,r),{...r,fromCache:!1}},H=(t=[],r=!1)=>{const[n,a]=e.useState(new Map),[s,l]=e.useState(!1),[i,o]=e.useState({current:0,total:0}),[c,u]=e.useState(null),d=e.useCallback(async e=>{const t=await F(e.url);return a(r=>new Map(r).set(e.url,t)),t},[]),m=e.useCallback(async()=>{if(0!==t.length){l(!0),o({current:0,total:t.length});try{const e=5,r=new Map;for(let n=0;n<t.length;n+=e){const a=t.slice(n,n+e);(await Promise.all(a.map(async e=>{const t=await F(e.url);return{url:e.url,health:t}}))).forEach(({url:e,health:t})=>{r.set(e,t)}),o({current:Math.min(n+e,t.length),total:t.length}),n+e<t.length&&await new Promise(e=>setTimeout(e,300))}a(r),u(new Date)}catch(e){}finally{l(!1)}}},[t]),p=e.useCallback(()=>{(()=>{try{Object.keys(localStorage).forEach(e=>{e.startsWith("channel_health_")&&localStorage.removeItem(e)})}catch(e){}})(),a(new Map),u(null)},[]),h=e.useCallback(()=>{let e=0,r=0,a=0,s=t.length-n.size;return n.forEach(t=>{t.isAlive?e++:"timeout"===t.status?a++:r++}),{total:t.length,online:e,offline:r,timeout:a,unchecked:s,checked:n.size,percentage:t.length>0?Math.round(e/t.length*100):0}},[t,n]),f=n.size;return e.useEffect(()=>{!r||0===t.length||f>0||m()},[r,t.length,f,m]),{healthMap:n,isChecking:s,progress:i,lastCheck:c,checkSingleChannel:d,checkAllChannels:m,clearCache:p,getStats:h(),getHealth:e=>n.get(e)||null}};function K({open:r,onClose:n,onSuccess:a}){const[s,l]=e.useState(""),[i,o]=e.useState(""),[c,u]=e.useState(""),[d,m]=e.useState(""),[p,h]=e.useState(!1),[f,g]=e.useState(""),y=e.useMemo(()=>(e=>{if(!e)return"unknown";const t=e.toLowerCase();return t.includes(".m3u8")?"hls":t.includes(".mpd")||t.includes("format=mpd")||t.includes("manifest.mpd")?"dash":/\.(mp4|webm|ogg)$/i.test(t)?"progressive":"unknown"})(c),[c]),b=s.trim()&&c.trim(),x=()=>{const e={name:s.trim(),url:c.trim(),logo:i.trim()||void 0,category:"Requested",number:null},t=(r=d)?String(r).split(/[\n,\s]+/).map(e=>e.trim()).filter(Boolean).map(e=>{const[t,r]=e.split(":").map(e=>e?.trim());return t&&r?{kid:t,k:r}:null}).filter(Boolean):[];var r;return"dash"===y&&t.length>0&&(e.dash={drm:{clearkey:{keys:t}}}),e};return r?t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60",children:t.jsxs("div",{className:"w-[92vw] max-w-3xl rounded-2xl bg-(--bg-secondary) text-white shadow-2xl border border-(--border-color)",children:[t.jsxs("div",{className:"p-5 border-b border-(--border-color) bg-linear-to-r from-(--brand-color)/30 to-red-700/20 rounded-t-2xl",children:[t.jsxs("h3",{className:"text-xl font-bold",children:["Add Your Requested Channels ",t.jsx("span",{className:"align-middle",children:"ðŸ˜Š"})]}),t.jsx("p",{className:"text-xs opacity-70",children:"(will be stored in admin panel)"})]}),t.jsxs("form",{onSubmit:async e=>{if(e?.preventDefault?.(),b&&!p){h(!0),g("");try{await(async()=>{try{S?.currentUser||await E(S)}catch(e){}})();const r=x();try{await k(N(j,"channel_requests"),{...r,createdAt:C(),uid:S?.currentUser?.uid||null})}catch(t){if("permission-denied"!==t?.code&&!/Missing or insufficient permissions/i.test(t?.message||""))throw t;(e=>{try{const t="pending_channel_requests",r=JSON.parse(localStorage.getItem(t)||"[]");r.push({...e,queuedAt:Date.now()}),localStorage.setItem(t,JSON.stringify(r))}catch(t){}})(r)}a?.(r),n?.(),l(""),o(""),u(""),m("")}catch(r){const e=r?.message||"Submission failed";g(/permission/i.test(e)?"Missing or insufficient permissions.":e)}finally{h(!1)}}},className:"p-5 grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsxs("label",{className:"text-xs uppercase tracking-wide",children:["Channel name ",t.jsx("span",{className:"text-red-400",children:"(required)"})]}),t.jsx("input",{value:s,onChange:e=>l(e.target.value),placeholder:"Enter channel name...",className:"p-3 rounded-lg bg-(--bg-tertiary) outline-none focus:ring-2 focus:ring-(--brand-color)"})]}),t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsxs("label",{className:"text-xs uppercase tracking-wide",children:["Channel Logo ",t.jsx("span",{className:"text-red-400",children:"(required)"})]}),t.jsx("input",{value:i,onChange:e=>o(e.target.value),placeholder:"Enter logo URL...",className:"p-3 rounded-lg bg-(--bg-tertiary) outline-none focus:ring-2 focus:ring-(--brand-color)"})]}),t.jsxs("div",{className:"flex flex-col gap-2 md:col-span-1",children:[t.jsxs("label",{className:"text-xs uppercase tracking-wide",children:["Channel Link ",t.jsx("span",{className:"text-red-400",children:"(required)"})]}),t.jsx("textarea",{value:c,onChange:e=>u(e.target.value),placeholder:"Enter streaming URL (m3u8 / mpd / mp4)",className:"p-3 rounded-lg min-h-[56px] bg-(--bg-tertiary) outline-none focus:ring-2 focus:ring-(--brand-color)"}),t.jsxs("span",{className:"text-xs opacity-70",children:["Detected: ",t.jsx("strong",{className:"uppercase",children:y})]})]}),t.jsxs("div",{className:"flex flex-col gap-2 md:col-span-1",children:[t.jsxs("label",{className:"text-xs uppercase tracking-wide",children:["KEY:KEY ",t.jsx("span",{className:"opacity-70",children:"(Optional, for clearkey mpd drm)"})]}),t.jsx("textarea",{value:d,onChange:e=>m(e.target.value),placeholder:"Enter clearkey pairs like KID:KEY (you can paste multiple separated by spaces or new lines)",className:"p-3 rounded-lg min-h-[56px] bg-(--bg-tertiary) outline-none focus:ring-2 focus:ring-(--brand-color)"}),d&&"dash"!==y&&t.jsxs("span",{className:"text-[10px] text-yellow-400",children:["Clearkey is only used for DASH (.mpd). Your link looks like ",y,"."]})]}),f&&t.jsx("div",{className:"md:col-span-2 text-red-400 text-sm",children:f}),t.jsxs("div",{className:"md:col-span-2 flex items-center justify-end gap-3 pt-2",children:[t.jsx("button",{type:"button",onClick:n,className:"px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-500",children:"Close"}),t.jsx("button",{type:"submit",disabled:!b||p,className:"px-4 py-2 rounded-lg font-semibold "+(b?"bg-(--brand-color) hover:bg-red-600":"bg-gray-700 cursor-not-allowed"),children:p?"Submittingâ€¦":"Submit Request"})]})]})]})}):null}const G={data:null,timestamp:0,promise:null},V={data:null,timestamp:0,promise:null},J=[{url:"https://raw.githubusercontent.com/SheyEm/PH_IPTV/main/PH.m3u",label:"SheyEm/PH_IPTV"},{url:"https://raw.githubusercontent.com/touchmetender/m3u/main/iptv.m3u",label:"touchmetender/m3u"},{url:"https://raw.githubusercontent.com/iptv-org/iptv/master/streams/ph.m3u",label:"iptv-org/streams/ph"}],Y=new Map,W=async(e,t,r=36e5)=>e.data&&Date.now()-e.timestamp<r?e.data:(e.promise||(e.promise=fetch(t).then(e=>{if(!e.ok)throw new Error(`Failed to fetch ${t} (${e.status})`);return e.json()}).then(t=>(e.data=t,e.timestamp=Date.now(),e.promise=null,t)).catch(t=>{throw e.promise=null,t})),e.promise),Q=e=>e?e.toLowerCase().replace(/[^a-z0-9\s]/g," ").replace(/\b(tv|channel|hd)\b/g," ").replace(/\s+/g," ").trim():"",X=e=>{if(!e)return null;const t=e.toLowerCase();return/\b(philippines|philippine|pinoy|filipino)\b/.test(t)||/\bph\b/.test(t)?"philippines":/\b(mongolia|mongolian)\b/.test(t)?"mongolia":/\b(thailand|thai)\b/.test(t)?"thailand":/\b(malaysia|malaysian)\b/.test(t)?"malaysia":/\b(indonesia|indonesian|indo)\b/.test(t)?"indonesia":/\b(singapore|sg)\b/.test(t)?"singapore":/\b(vietnam|vietnamese)\b/.test(t)?"vietnam":/\b(uae|dubai|arab|middle east)\b/.test(t)?"uae":/\b(india|indian)\b/.test(t)?"india":/\b(pakistan|pakistani)\b/.test(t)?"pakistan":/\b(japan|japanese)\b/.test(t)?"japan":/\b(korea|korean)\b/.test(t)?"korea":/\b(china|chinese)\b/.test(t)?"china":/\b(usa|us|united states|america|american)\b/.test(t)?"usa":/\b(uk|britain|british|england|london)\b/.test(t)?"uk":null},Z={PH:"philippines",PHL:"philippines",US:"usa",USA:"usa",GB:"uk",GBR:"uk",SG:"singapore",SGP:"singapore",MY:"malaysia",MYS:"malaysia",ID:"indonesia",IDN:"indonesia",TH:"thailand",THA:"thailand",JP:"japan",JPN:"japan",KR:"korea",KOR:"korea",VN:"vietnam",VNM:"vietnam",CN:"china",CHN:"china",AE:"uae",ARE:"uae",IN:"india",IND:"india",PK:"pakistan",PAK:"pakistan",MN:"mongolia",MNG:"mongolia"},ee=e=>e&&Z[e.toUpperCase()]||null,te=e=>{const t=Q(e);return t?t.split(" ").filter(Boolean):[]},re=e=>{if(!e)return null;let t=X(e.name);if(!t&&Array.isArray(e.alt_names))for(const r of e.alt_names)if(t=X(r),t)break;return!t&&e.country&&(t=ee(e.country)),t},ne=(e,t)=>{if(!e||!t)return 0;if(e===t)return 100;if(e.includes(t))return 80;if(t.includes(e))return 70;const r=new Set(e.split(" ")),n=t.split(" ");let a=0;return n.forEach(e=>{r.has(e)&&(a+=10)}),Math.min(60,a)},ae=e=>{if(!e)return 0;if("number"==typeof e)return e;const t=e.toLowerCase();if("uhd"===t||"4k"===t)return 2160;if("fhd"===t)return 1080;if("hd"===t)return 720;const r=/([0-9]{3,4})p/.exec(t);return r?parseInt(r[1],10):0},se=e=>{if(!e)return"unknown";const t=e.toLowerCase();return t.includes(".m3u8")||t.includes("format=m3u8")?"hls":t.includes(".mpd")||t.includes("manifest.mpd")?"dash":/(\.mp4|\.mkv|\.ts)(\?|$)/.test(t)?"progressive":"unknown"},le=e=>!!e&&(e.includes("youtube.com")||e.includes("youtu.be")),ie=async(e,t)=>{const r=Q(e);if(!r)return[];const{maxResults:n=5,localOnly:a=!1,country:s="PH",localRegion:l}=t,i=X(e),o=new Set(te(e)),c=l||ee(s)||i,u=await Promise.all(J.map(async e=>{try{return await(async(e,t=36e5)=>{const r=Y.get(e.url);if(r){if(r.data&&Date.now()-r.timestamp<t)return r.data;if(r.promise)return r.promise}const n=fetch(e.url).then(t=>{if(!t.ok)throw new Error(`Failed to fetch playlist ${e.url} (${t.status})`);return t.text()}).then(t=>{const r=((e,t)=>{if(!e)return[];const r=e.split(/\r?\n/),n=[];for(let a=0;a<r.length;a++){const e=r[a]?.trim();if(!e||!e.startsWith("#EXTINF"))continue;const s=e;let l="",i=a+1;for(;i<r.length;){const e=r[i]?.trim();if(e){if(e.startsWith("#EXTINF"))break;if(!e.startsWith("#")){l=e;break}i+=1}else i+=1}if(!l)continue;const o=s.includes(",")?s.split(",").pop()?.trim():null,c=s.match(/tvg-id="([^"]+)"/i),u=s.match(/tvg-logo="([^"]+)"/i),d=s.match(/group-title="([^"]+)"/i),m=s.match(/,\s*([0-9]{3,4}p)/i);n.push({id:c?.[1]||o||l,name:o||c?.[1]||l,url:l,logo:u?.[1]||null,group:d?.[1]||null,quality:m?.[1]||null,sourceId:t.url,sourceLabel:t.label})}return n})(t,e);return Y.set(e.url,{data:r,timestamp:Date.now(),promise:null}),r}).catch(t=>{throw Y.delete(e.url),t});return Y.set(e.url,{data:null,timestamp:Date.now(),promise:n}),n})(e)}catch(t){return[]}})),d=u.flat();if(!d.length)return[];const m=new Map;d.forEach(e=>{if(!e?.name||!e?.url)return;const t=Q(e.name),n=ne(t,r);if(n<=0)return;let s=X(e.name);if(!s&&e.group&&(s=X(e.group)),!s&&e.sourceId){const t=e.sourceId.toLowerCase();t.includes("/ph")||t.includes("philippines")?s="philippines":t.includes("/sg")||t.includes("singapore")?s="singapore":(t.includes("/th")||t.includes("thailand"))&&(s="thailand")}if(!s&&e.sourceLabel){const t=e.sourceLabel.toLowerCase();(t.includes("philippines")||t.includes("ph "))&&(s="philippines")}let l=n;if(i&&s&&i!==s?l-=40:i&&!s&&(l-=10),s&&i&&s===i&&(l+=15),o.size>0){const t=new Set(te(e.name));let r=0;o.forEach(e=>{t.has(e)||(r+=1)}),0===r?l+=10:l-=5*r}if(a&&c){if(s&&s!==c)return;s||(l-=15)}if(l<=0)return;const u={url:e.url,quality:e.quality||null,streamType:se(e.url),userAgent:null,referrer:null,requiresProxy:le(e.url),source:e.sourceLabel},d=`${e.sourceId}:${e.id}`;if(m.has(d))return m.get(d).streams.push(u),void(m.get(d).score=Math.max(m.get(d).score,l));m.set(d,{id:e.id,name:e.name,logo:e.logo||null,country:null,categories:e.group?[e.group]:[],source:e.sourceLabel,score:l,region:s,origin:"playlist",streams:[u]})});let p=Array.from(m.values()).map(e=>({...e,streams:e.streams.sort((e,t)=>ae(t.quality)-ae(e.quality))})).sort((e,t)=>t.score-e.score);return a&&c&&(p=p.filter(e=>!!e&&(!e.region||e.region===c))),p.slice(0,n)},oe=e=>"playlist"===e?2:"api"===e?1:0,ce=(e,t)=>{const r=oe(e?.origin),n=oe(t?.origin);if(r!==n)return n-r;const a=e?.score??0,s=t?.score??0;if(a!==s)return s-a;const l=(e?.name||"").toLowerCase(),i=(t?.name||"").toLowerCase();return l<i?-1:l>i?1:0},ue=async(e,t={})=>{const{country:r="PH",maxResults:n=5,includeInternational:a,localOnly:s=!1,localRegion:l}=t,i=!s&&(a??!1),o=r||"PH",c=ee(o),u=l||c||null;if(!e)return[];const[d,m,p]=await Promise.all([W(G,"https://iptv-org.github.io/api/channels.json"),W(V,"https://iptv-org.github.io/api/streams.json"),ie(e,{maxResults:n,localOnly:s,country:o,localRegion:u})]),h=((e,t,r)=>{const{country:n="PH",maxResults:a=5,includeInternational:s=!1,localOnly:l=!1,targetRegion:i=null}=r,o=Q(t),c=X(t),u=i||c||null,d=new Set(te(t)),m=n.toUpperCase(),p=i||ee(n)||c;return o?e.filter(e=>{if(!e?.name)return!1;if(!s&&e.country&&e.country!==n)return!1;if(l){const t=e.country?e.country.toUpperCase():null,r=re(e);if(t&&t!==m&&(!p||!r||r!==p))return!1;if(!t&&p&&r&&r!==p)return!1}const t=Q(e.name),r=!!Array.isArray(e.alt_names)&&e.alt_names.some(e=>Q(e).includes(o));return Math.max(ne(t,o),r?50:0)>0}).map(e=>{const r=Q(e.name),n=Array.isArray(e.alt_names)?Math.max(...e.alt_names.map(e=>ne(Q(e),o))):0,a=Math.max(ne(r,o),n),i=new Set(te(e.name));Array.isArray(e.alt_names)&&e.alt_names.forEach(e=>{te(e).forEach(e=>i.add(e))});const h=re(e),f=e.country?e.country.toUpperCase():null;let g=a;if(r===o?g+=30:e.name?.toLowerCase()===String(t||"").toLowerCase()&&(g+=20),d.size>0){let e=0;d.forEach(t=>{i.has(t)||(e+=1)}),0===e?g+=15:g-=6*e}f&&(f===m?g+=25:g-=s?25:50),u?h&&h===u?g+=25:g-=h&&h!==u?40:12:c&&(h&&h===c?g+=15:h&&h!==c&&(g-=20)),l&&p&&(h&&h!==p?g-=45:h||(g-=15));const y=g;return{id:e.id,name:e.name,logo:e.logo??e.tvg_logo??null,country:e.country,categories:e.categories||[],score:y,region:h,origin:"api"}}).filter(e=>e.score>0).sort((e,t)=>t.score-e.score).slice(0,a):[]})(d,e,{country:o,maxResults:n,includeInternational:i,localOnly:s,targetRegion:u}),f=((e,t)=>{const r=t.reduce((e,t)=>t?.channel?(e.has(t.channel)||e.set(t.channel,[]),e.get(t.channel).push(t),e):e,new Map);return e.map(e=>{const t=(r.get(e.id)||[]).filter(e=>"string"==typeof e.url).map(e=>({url:e.url,quality:e.quality||null,streamType:se(e.url),userAgent:e.user_agent||null,referrer:e.referrer||null,requiresProxy:le(e.url),raw:e})).sort((e,t)=>ae(t.quality)-ae(e.quality));return{...e,streams:t}})})(h,m);let g=(e=>{const t=new Set;return e.map(e=>{const r=e.streams.filter(e=>!!e?.url&&!t.has(e.url)&&(t.add(e.url),!0));return r.length?{...e,streams:r}:null}).filter(Boolean)})([...p,...f.filter(e=>e.streams.length>0)].sort(ce));return s&&(g=g.filter(e=>{if(!e)return!1;if(e.country&&e.country.toUpperCase()!==o.toUpperCase()){if(!u)return!1;if((e.region||ee(e.country)||X(e.name))!==u)return!1}if(u){const t=e.region||ee(e.country)||X(e.name);if(t&&t!==u)return!1}return!0})),g.length?g.sort(ce):[]},de=e=>e?String(e).toLowerCase().replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim():"",me=e=>de(e).split(" ").filter(Boolean),pe=[{label:"PH Mirror Pack",region:"philippines",updatedAt:"2025-11-04",entries:[{name:"PTV 4",category:"Government",patterns:["ptv","ptv 4","ptv4","peoples television network","people television"],streams:[{url:"https://qp-pldt-live-grp-02-prod.akamaized.net/out/u/cg_ptv4_sd.mpd",quality:"576p",streamType:"dash",source:"community-mirror"},{url:"https://qp-pldt-live-grp-02-prod.akamaized.net/out/u/cg_ptv4_sd.m3u8",quality:"576p",streamType:"hls",source:"community-mirror"}]},{name:"TV5",category:"Entertainment",patterns:["tv5","tv 5","kapatid channel","tv5 philippines","tv5 kapatid"],streams:[{url:"https://qp-pldt-live-grp-03-prod.akamaized.net/out/u/cg_tv5_hd.mpd",quality:"720p",streamType:"dash",source:"community-mirror",requiresProxy:!1},{url:"https://qp-pldt-live-grp-03-prod.akamaized.net/out/u/cg_tv5_hd.m3u8",quality:"720p",streamType:"hls",source:"community-mirror",requiresProxy:!1}]},{name:"IBC 13",category:"Government",patterns:["ibc","ibc 13","intercontinental broadcasting corporation"],streams:[{url:"https://qp-pldt-live-grp-03-prod.akamaized.net/out/u/cg_ibc13_sd.mpd",quality:"480p",streamType:"dash",source:"community-mirror"},{url:"https://qp-pldt-live-grp-03-prod.akamaized.net/out/u/cg_ibc13_sd.m3u8",quality:"480p",streamType:"hls",source:"community-mirror"}]},{name:"One PH",category:"News",patterns:["one ph","oneph","cignal one ph"],streams:[{url:"https://qp-pldt-live-grp-02-prod.akamaized.net/out/u/cg_oneph_sd.mpd",quality:"540p",streamType:"dash",source:"community-mirror"},{url:"https://qp-pldt-live-grp-02-prod.akamaized.net/out/u/cg_oneph_sd.m3u8",quality:"540p",streamType:"hls",source:"community-mirror"}]},{name:"GMA 7",category:"Entertainment",patterns:["gma 7","gma7","gma network","kapuso channel"],streams:[{url:"https://tmob-p1.cdn.asset.apac.t5c.xyz/PLDT-P1/HLS/asset.m3u8",quality:"720p",streamType:"hls",source:"community-mirror"}]},{name:"Kapamilya Channel",category:"Entertainment",patterns:["kapamilya channel","kapamilya online","abs cbn kapamilya"],streams:[{url:"https://tmob-p1.cdn.asset.apac.t5c.xyz/ABS-CBN/Kapamilya/playlist.m3u8",quality:"720p",streamType:"hls",source:"community-mirror"}]},{name:"A2Z Channel 11",category:"Entertainment",patterns:["a2z","a2z channel 11","a2z philippines"],streams:[{url:"https://tmob-p1.cdn.asset.apac.t5c.xyz/A2Z/primary/playlist.m3u8",quality:"720p",streamType:"hls",source:"community-mirror"}]},{name:"Cignal One News",category:"News",patterns:["one news","cignal news","cignal one news"],streams:[{url:"https://qp-pldt-live-grp-01-prod.akamaized.net/out/u/cg_onenews_hd.mpd",quality:"720p",streamType:"dash",source:"community-mirror"},{url:"https://qp-pldt-live-grp-01-prod.akamaized.net/out/u/cg_onenews_hd.m3u8",quality:"720p",streamType:"hls",source:"community-mirror"}]},{name:"CNN Philippines",category:"News",patterns:["cnn philippines","cnn ph","cnnph"],streams:[{url:"https://qp-pldt-live-grp-03-prod.akamaized.net/out/u/cnn_cnnph_prod_hd.mpd",quality:"720p",streamType:"dash",source:"community-mirror"},{url:"https://qp-pldt-live-grp-03-prod.akamaized.net/out/u/cnn_cnnph_prod_hd.m3u8",quality:"720p",streamType:"hls",source:"community-mirror"}]},{name:"Net 25",category:"Entertainment",patterns:["net25","net 25"],streams:[{url:"https://qp-pldt-live-grp-02-prod.akamaized.net/out/u/cg_net25_sd.mpd",quality:"540p",streamType:"dash",source:"community-mirror"},{url:"https://qp-pldt-live-grp-02-prod.akamaized.net/out/u/cg_net25_sd.m3u8",quality:"540p",streamType:"hls",source:"community-mirror"}]},{name:"UNTV",category:"News",patterns:["untv","untv philippines"],streams:[{url:"https://qp-pldt-live-grp-02-prod.akamaized.net/out/u/cg_untv_sd.mpd",quality:"540p",streamType:"dash",source:"community-mirror"},{url:"https://qp-pldt-live-grp-02-prod.akamaized.net/out/u/cg_untv_sd.m3u8",quality:"540p",streamType:"hls",source:"community-mirror"}]}]}],he="iptv_discovery_cache_v1",fe=10,ge=e=>{if(!e)return"";const t=[e.discoveryKey,e.id,e.slug,e.name,e.number,e.originalName].filter(e=>null!=e).map(e=>String(e).trim().toLowerCase()).filter(Boolean),r=t.length?t.join("::"):"",n="string"==typeof e.url?e.url.trim().toLowerCase():"";return r||n},ye=()=>{const{channels:r,isSyncing:n,syncStatus:a,syncChannels:s,hasUpdates:l}=z(!0),[i,o]=e.useState(()=>{try{return JSON.parse(localStorage.getItem("iptv_user_channels")||"[]")}catch{return[]}}),c=e.useMemo(()=>{let e=[];try{e=JSON.parse(localStorage.getItem("pending_channel_requests")||"[]")}catch{e=[]}const t=e.filter(e=>e?.url),n=new Map;return[...i,...t,...r].forEach(e=>{e?.url&&!n.has(e.url)&&n.set(e.url,e)}),Array.from(n.values())},[r,i]),{healthMap:u,isChecking:d,progress:m,checkAllChannels:p,getStats:h,getHealth:f}=H(c,!0),[g,w]=e.useState(null),[k,N]=e.useState(!1),[j,S]=e.useState(""),[C,E]=e.useState("all"),[q,L]=e.useState(()=>{try{return JSON.parse(localStorage.getItem("iptv_favorites")||"[]")}catch{return[]}}),[T,P]=e.useState(!1),{discover:I}=((t={})=>{const[r,n]=e.useState(!1),[a,s]=e.useState(null),[l,i]=e.useState([]),o=e.useMemo(()=>({...t}),[t]);return{discover:e.useCallback(async(e,t={})=>{n(!0),s(null);try{const r=await ue(e,{...o,...t});return i(r),r}catch(r){throw s(r),i([]),r}finally{n(!1)}},[o]),reset:e.useCallback(()=>{i([]),s(null)},[]),isLoading:r,error:a,results:l}})({country:"PH",maxResults:6,includeInternational:!1,localOnly:!0,verify:!0,verifyLimit:2,verifyTimeout:4e3}),_=e.useRef(new Map),R=e.useRef(null),M=e.useRef(null),U=e.useRef(null),O=e.useRef(!1),D=e.useRef(!1),[B,F]=e.useState(!1),[G,V]=e.useState(null),J=e.useCallback(e=>{if(!e||!e.name)return e;const t=ge(e);if(!t)return e;const r=_.current.get(t);if(!r||!Array.isArray(r.queue)||0===r.queue.length)return e;const n=Date.now(),a=r.queue.filter(e=>!(!e||"string"!=typeof e.url||e.url.length<5)&&(!e.requiresProxy&&(!e.health||!1!==e.health.isAlive)));if(!a.length)return e;const s=a.filter(e=>!!e.lastSuccess&&n-e.lastSuccess<=432e5);if(!s.length)return e;const l=s.reduce((e,t)=>{if(!e)return t;const r=e.lastSuccess||0;return(t.lastSuccess||0)>r?t:e},null);if(!l||!l.url)return e;return("string"==typeof e.url?e.url.trim():"")===l.url?e:{...e,url:l.url,originalUrl:e.originalUrl||e.url,type:l.type||e.type,discoveryKey:e.discoveryKey||t,discoveryMeta:{candidateName:l.candidateName||e.name,quality:l.quality||null,source:l.source||"discovery-cache",reason:"cached-success",verified:"boolean"==typeof l.health?.isAlive?l.health.isAlive:null,cacheKey:t,streamUrl:l.url,type:l.type||null,health:l.health||null,discoveredAt:l.discoveredAt||null,attemptedAt:l.lastAttempt||l.attemptedAt||null,requiresProxy:Boolean(l.requiresProxy),restoredFromCache:!0,lastSuccess:l.lastSuccess||null}}},[]);e.useEffect(()=>{if(0===c.length)return;const e=localStorage.getItem("iptv_last_channel");let t=null;e&&(t=c.find(t=>t.url===e)),!t&&c.length>0&&(t=c[0]);const r=J(t);w(r),N(!!r)},[c,J]),e.useEffect(()=>{if(!k)return;const e=setTimeout(()=>{N(!1)},1e4);return()=>clearTimeout(e)},[k]),e.useEffect(()=>{g?.url&&localStorage.setItem("iptv_last_channel",g.url)},[g?.url]),e.useEffect(()=>{M.current=g},[g]),e.useEffect(()=>{if(!G||B)return;const e=setTimeout(()=>{V(null)},12e3);return()=>clearTimeout(e)},[G,B]),e.useEffect(()=>{const e=g?.discoveryMeta;e&&e.restoredFromCache&&(F(!1),V("Using cached backup stream"+(e.source?` (${e.source})`:"")))},[g]);const Y=e.useCallback((e=!1)=>{if("undefined"==typeof window)return;const t=()=>{U.current=null;try{const e={};_.current.forEach((t,r)=>{if(!t||!Array.isArray(t.queue)||0===t.queue.length)return;const n=t.queue.filter(e=>e&&"string"==typeof e.url&&e.url.length>4).slice(0,fe).map(e=>({url:e.url,type:e.type??null,quality:e.quality??null,source:e.source??null,candidateName:e.candidateName??null,requiresProxy:Boolean(e.requiresProxy),health:e.health&&"object"==typeof e.health?{isAlive:"boolean"==typeof e.health.isAlive?e.health.isAlive:null,status:e.health.status??null,latency:e.health.latency??null}:null,lastSuccess:e.lastSuccess??null,discoveredAt:e.discoveredAt??null,attemptedAt:e.lastAttempt??e.attemptedAt??null}));if(!n.length)return;const a=Array.from(t.attempts instanceof Set?t.attempts:new Set(Array.isArray(t.attempts)?t.attempts:[])).filter(e=>"string"==typeof e&&e.length>4);e[r]={queue:n,timestamp:t.timestamp||Date.now(),attempts:a}}),localStorage.setItem(he,JSON.stringify(e))}catch(e){}};if(e)return U.current&&(clearTimeout(U.current),U.current=null),void t();U.current||(U.current=setTimeout(t,500))},[]);e.useEffect(()=>()=>{U.current&&(clearTimeout(U.current),U.current=null),Y(!0)},[Y]),e.useEffect(()=>{if("undefined"!=typeof window&&!O.current){O.current=!0;try{const e=localStorage.getItem(he);if(!e)return;const t=JSON.parse(e);if(!t||"object"!=typeof t)return;const r=_.current;Object.entries(t).forEach(([e,t])=>{if(!t||!Array.isArray(t.queue)||0===t.queue.length)return;const n=t.queue.map(e=>!e||"string"!=typeof e.url||e.url.length<5?null:{url:e.url,type:e.type??void 0,quality:e.quality??null,source:e.source??null,candidateName:e.candidateName??null,requiresProxy:Boolean(e.requiresProxy),health:e.health&&"object"==typeof e.health?{isAlive:"boolean"==typeof e.health.isAlive?e.health.isAlive:null,status:e.health.status??null,latency:e.health.latency??null}:null,lastSuccess:e.lastSuccess??null,discoveredAt:e.discoveredAt??null,lastAttempt:e.attemptedAt??null}).filter(Boolean).slice(0,fe);n.length&&r.set(e,{queue:n,index:0,attempts:new Set(Array.isArray(t.attempts)?t.attempts.filter(e=>"string"==typeof e&&e.length>4):[]),timestamp:t.timestamp||0,pending:null})})}catch(e){}}},[]),e.useEffect(()=>{if(!O.current)return;if(D.current)return;if(!c.length)return;let e=!1;const t=Date.now();c.forEach(r=>{const n=ge(r);if(!n)return;const a=((e,{maxResults:t=5,localOnly:r=!1,targetRegion:n=null}={})=>{if(!de(e))return[];const a=me(e),s=[];return pe.forEach(e=>{const t=e.region||null;r&&n&&t&&t!==n||e.entries.forEach(r=>{if(!(Array.isArray(r.patterns)?r.patterns:[]).some(e=>{const t=me(e);return!!t.length&&t.every(e=>a.includes(e))}))return;const n=(r.streams||[]).map(t=>({url:t.url,quality:t.quality||null,streamType:t.streamType||null,userAgent:null,referrer:null,requiresProxy:Boolean(t.requiresProxy),source:t.source||e.label})).filter(e=>"string"==typeof e.url&&e.url.length>4);n.length&&s.push({id:`seed:${e.label}:${r.name}`,name:r.name,logo:r.logo||null,country:"PH",categories:r.categories||["Community"],source:r.source||e.label,score:45,region:t,origin:"seed",streams:n})})}),s.length?s.slice(0,t):[]})(r.name,{maxResults:fe,localOnly:!0,targetRegion:"philippines"});if(!a.length)return;let s=_.current.get(n);s||(s={queue:[],index:0,attempts:new Set,timestamp:0,pending:null},_.current.set(n,s)),s.attempts instanceof Set||(s.attempts=new Set(Array.isArray(s.attempts)?s.attempts:[])),Array.isArray(s.queue)||(s.queue=[]),a.forEach(r=>{r.streams.forEach(n=>{if(!n?.url)return;s.queue.some(e=>e?.url===n.url)||(s.queue.push({url:n.url,type:n.streamType||null,quality:n.quality||null,source:n.source||r.source||"seeded-scrape",candidateName:r.name,requiresProxy:Boolean(n.requiresProxy),health:null,lastSuccess:null,discoveredAt:t,attemptedAt:null,seeded:!0}),e=!0)})}),s.queue.length>fe&&(s.queue=s.queue.slice(0,fe)),e&&(s.timestamp=t)}),e&&Y(!0),D.current=!0},[c,Y]),e.useEffect(()=>{localStorage.setItem("iptv_favorites",JSON.stringify(q))},[q]);const W=e.useCallback(e=>{if(!e||!e.url)return;const t=e.discoveryMeta?.cacheKey||ge(e);if(!t)return;let r=_.current.get(t);r||(r={queue:[],index:0,attempts:new Set,timestamp:0,pending:null},_.current.set(t,r)),Array.isArray(r.queue)||(r.queue=[]),r.attempts instanceof Set||(r.attempts=new Set(Array.isArray(r.attempts)?r.attempts:[]));const n=e.url,a=r.queue,s=a.findIndex(e=>e?.url===n),l=s>=0?a[s]:null,i=e.discoveryMeta||{},o={...l||{},url:n,type:i.type||e.type||l?.type,candidateName:i.candidateName||l?.candidateName||e.name,source:i.source||l?.source||"discovery",quality:i.quality||l?.quality||null,requiresProxy:Boolean(i.requiresProxy??l?.requiresProxy),health:(()=>{const e={...l?.health||{}};return"boolean"==typeof i.verified&&(e.isAlive=i.verified),i.health&&"object"==typeof i.health&&("boolean"==typeof i.health.isAlive&&(e.isAlive=i.health.isAlive),i.health.status&&(e.status=i.health.status),null!=i.health.latency&&(e.latency=i.health.latency)),Object.keys(e).length?e:null})(),lastSuccess:Date.now()},c=a.filter((e,t)=>e&&e.url&&t!==s&&e.url!==n).slice(0,9);r.queue=[o,...c],r.index=0,r.timestamp=Date.now();const u=n.trim(),d=new Set;r.attempts.forEach(e=>{if("string"!=typeof e)return;const t=e.trim();t&&t!==u&&d.add(t)}),r.attempts=d,_.current.set(t,r),Y(),F(!1);const m=i.source||i.candidateName||e.name;V("Stream verified"+(m?` (${m})`:""))},[Y]);e.useEffect(()=>{if(0===c.length)return;c.some(e=>!u.get(e.url))&&!d&&p()},[c,u,d,p]),e.useEffect(()=>{if(0===c.length)return;const e=setInterval(()=>{d||p()},9e5);return()=>clearInterval(e)},[c.length,d,p]);const Q=e.useMemo(()=>["all",...new Set(c.map(e=>e.category).filter(Boolean))],[c]),X=e.useMemo(()=>{if(!G)return"";if(B)return"text-yellow-400 animate-pulse";const e=G.toLowerCase();return e.includes("failed")||e.includes("no backup")?"text-red-400":e.includes("attempting")||e.includes("switching")?"text-yellow-400":"text-green-400"},[G,B]),Z=e.useMemo(()=>c.filter(e=>{const t=e.name.toLowerCase().includes(j.toLowerCase()),r="all"===C||e.category===C;return t&&r}),[c,j,C]),ee=e.useCallback(e=>{if(!e)return;const t=J(e);(t?.url||e.url)!==g?.url&&(N(!0),w(t??e),F(!1),V(null))},[J,g?.url]),te=e.useCallback((e,t)=>{t.stopPropagation(),L(t=>t.includes(e.name)?t.filter(t=>t!==e.name):[...t,e.name])},[]),re=e.useCallback(()=>{N(!1),F(!1);const e=M.current;e?.discoveryMeta?.streamUrl&&W(e)},[W]),ne=e.useCallback((e,t={})=>{if(R.current)return R.current;const{skipFailure:r=!1,forceRefresh:n=!1}=t,a=M.current;if(a?.name){V(`${"manual-discovery"===e?"Searching backups for":"Recovering stream for"} ${a.name}...`)}else V("Searching for backup stream...");F(!0);const s=(async()=>{const t=M.current;if(!t||!t.name)return N(!1),void F(!1);N(!0);const a=ge(t);if(!a)return N(!1),void F(!1);let s=_.current.get(a);s?s.attempts instanceof Set||(s.attempts=new Set(Array.isArray(s.attempts)?s.attempts:[])):(s={queue:[],index:0,attempts:new Set,timestamp:0,pending:null},_.current.set(a,s));let l=!1;const i=e=>{if(r)return;if(!e||"string"!=typeof e)return;const t=e.trim();t.length<5||s.attempts.has(t)||(s.attempts.add(t),l=!0)};i(t.url),i(t.originalUrl);const o=Date.now(),c=n||!s.queue.length||s.index>=s.queue.length||o-s.timestamp>18e5;n&&(s.queue=Array.isArray(s.queue)?s.queue:[],s.index=0,s.timestamp=0);if(c){s.pending||(s.pending=(async()=>{const e=await I(t.name,{verify:!0,verifyLimit:2,includeInternational:!1,localOnly:!0}),r=[],n=new Set,a=Date.now();e.forEach(e=>{e?.streams?.length&&e.streams.forEach(t=>{const s="string"==typeof t?.url?t.url.trim():"";s.length<5||n.has(s)||(n.add(s),r.push({url:s,type:t.streamType&&"unknown"!==t.streamType?t.streamType:void 0,requiresProxy:Boolean(t.requiresProxy),health:t.health||null,quality:t.quality||null,candidateName:e.name,source:t.source||e.source||"discovery",discoveredAt:a}))})}),s.queue=r,s.index=0,s.timestamp=Date.now(),l=!0})());try{await s.pending}catch(d){return N(!1),F(!1),void(l&&Y())}finally{s.pending=null}}let u=null;for(;s.index<s.queue.length;){const e=s.queue[s.index];if(s.index+=1,e?.url)if(e.requiresProxy)i(e.url);else if(!s.attempts.has(e.url))if(e.health&&!1===e.health.isAlive)i(e.url);else if(e.url!==t.url){e.lastAttempt=Date.now(),s.timestamp=Date.now(),u=e,l=!0;break}}if(!u)return A.warn("[IPTV] No discovery fallback streams available for",t.name),N(!1),F(!1),V("No backup stream found"),void(l&&Y());A.info("[IPTV] Switching to discovery fallback stream",u.url),N(!0),w(t=>{if(!t)return t;return{...t,url:u.url,originalUrl:t.originalUrl||t.url,type:u.type||t.type,discoveryKey:t.discoveryKey||a,discoveryMeta:{candidateName:u.candidateName,quality:u.quality,source:u.source,reason:e,verified:"boolean"==typeof u.health?.isAlive?u.health.isAlive:null,cacheKey:a,streamUrl:u.url,type:u.type||null,health:u.health||null,discoveredAt:u.discoveredAt||Date.now(),attemptedAt:u.lastAttempt||Date.now(),requiresProxy:Boolean(u.requiresProxy)}}}),V(`Switching to backup stream${u.candidateName?` (${u.candidateName})`:""}${u.source?` from ${u.source}`:""}`),l&&Y()})();return R.current=s.catch(e=>{N(!1),F(!1),V("Backup search failed")}).finally(()=>{R.current=null}),R.current},[I,Y]),ae=e.useCallback(()=>{g&&ne("manual-discovery",{skipFailure:!0,forceRefresh:!0})},[ne,g]),se=e.useCallback(e=>{const t="string"==typeof e?{url:e}:e||{},r=t?.url;if(!r)return A.warn("Player error with no static fallback URL available. Triggering discovery.",t.reason||""),F(!0),void ne(t.reason||"no-static-fallback");N(!0),V("Attempting built-in fallback stream..."),F(!1);let n=!1,a=!1;w(e=>{if(!e)return N(!1),e;if(e.url===r&&(!t.type||e.type===t.type))return N(!1),a=!0,e;const s={...e,url:r},l=t.originalUrl||e.originalUrl||e.url;return l&&(s.originalUrl=l),t.type&&(s.type=t.type),s.discoveryMeta&&delete s.discoveryMeta,n=!0,s}),!n&&a&&ne(t.reason||"duplicate-fallback")},[ne]);return t.jsxs("div",{className:"px-4 sm:px-8 md:px-16 pt-28 pb-20 min-h-screen",children:[t.jsxs("div",{className:"max-w-7xl mx-auto",children:[t.jsxs("div",{className:"flex flex-col gap-4 md:flex-row md:items-start md:justify-between mb-6",children:[t.jsxs("div",{className:"flex flex-col gap-3",children:[t.jsx("h1",{className:"text-3xl sm:text-4xl md:text-5xl font-bold bg-linear-to-r from-(--brand-color) to-red-600 bg-clip-text text-transparent",children:"Live TV"}),G&&t.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-200",children:[t.jsx(y,{className:X,size:10}),t.jsx("span",{className:"leading-snug",children:G})]})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 sm:gap-3 md:justify-end",children:[t.jsxs("button",{onClick:p,disabled:d,className:"flex items-center gap-2 px-3 sm:px-4 py-2 rounded-lg font-semibold transition-all "+(d?"bg-blue-600 cursor-not-allowed":"bg-blue-600 hover:bg-blue-500"),title:"Check channel health",children:[t.jsx(b,{className:d?"animate-pulse":""}),t.jsx("span",{className:"hidden sm:inline",children:d?`Checking ${m.current}/${m.total}...`:"Check Health"}),t.jsx("span",{className:"sm:hidden text-xs font-semibold",children:d?"Checking":"Health"})]}),t.jsxs("button",{onClick:s,disabled:n,className:"flex items-center gap-2 px-3 sm:px-4 py-2 rounded-lg font-semibold transition-all "+(n?"bg-gray-600 cursor-not-allowed":l?"bg-yellow-600 hover:bg-yellow-500 animate-pulse":"success"===a?"bg-green-600 hover:bg-green-500":"bg-(--brand-color) hover:bg-red-600"),title:l?"Channel updates available!":"Sync IPTV channels",children:[t.jsx(x,{className:n?"animate-spin":""}),t.jsx("span",{className:"hidden sm:inline",children:n?"Syncing...":l?`${r.length} Channels (Updates!)`:`${r.length} Channels`}),t.jsx("span",{className:"sm:hidden text-xs font-semibold",children:n?"Sync":`${r.length}`})]}),t.jsxs("button",{onClick:ae,disabled:B||!g,className:"flex items-center gap-2 px-3 sm:px-4 py-2 rounded-lg font-semibold transition-all "+(B||!g?"bg-indigo-700 cursor-not-allowed":"bg-indigo-600 hover:bg-indigo-500"),title:"Search for alternative streams",children:[t.jsx(v,{className:B?"animate-pulse":""}),t.jsx("span",{className:"hidden md:inline",children:B?"Searching...":"Find Backup"}),t.jsx("span",{className:"md:hidden text-xs font-semibold",children:B?"Searching":"Backup"})]}),t.jsxs("button",{onClick:()=>P(!0),className:"flex items-center gap-2 px-3 sm:px-4 py-2 rounded-lg font-semibold bg-purple-600 hover:bg-purple-500",title:"Suggest a new channel",children:[t.jsx("span",{className:"sm:hidden text-xs font-semibold",children:"Request"}),t.jsx("span",{className:"hidden sm:inline",children:"+ Request Channel"})]})]})]}),h.checked>0&&t.jsxs("div",{className:"bg-(--bg-secondary) rounded-xl p-4 mb-6 flex flex-col gap-4 md:flex-row md:items-center md:justify-between",children:[t.jsxs("div",{className:"flex flex-wrap items-center gap-4 md:gap-6",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(y,{className:"text-green-500 text-xs"}),t.jsxs("span",{className:"text-sm",children:[t.jsx("strong",{className:"text-green-500",children:h.online})," Online"]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(y,{className:"text-red-500 text-xs"}),t.jsxs("span",{className:"text-sm",children:[t.jsx("strong",{className:"text-red-500",children:h.offline})," Offline"]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(y,{className:"text-yellow-500 text-xs"}),t.jsxs("span",{className:"text-sm",children:[t.jsx("strong",{className:"text-yellow-500",children:h.timeout})," Timeout"]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(y,{className:"text-gray-500 text-xs"}),t.jsxs("span",{className:"text-sm",children:[t.jsx("strong",{className:"text-gray-500",children:h.unchecked})," Unchecked"]})]})]}),t.jsxs("div",{className:"text-center md:text-right",children:[t.jsxs("div",{className:"text-2xl font-bold text-(--brand-color)",children:[h.percentage,"%"]}),t.jsx("div",{className:"text-xs opacity-70",children:"Health Score"})]})]}),t.jsxs("div",{className:"grid gap-6 md:grid-cols-3 mb-6",children:[t.jsxs("div",{className:"md:col-span-2 bg-(--bg-secondary) rounded-2xl overflow-hidden shadow-2xl",children:[t.jsxs("div",{className:"bg-linear-to-r from-(--brand-color) to-red-700 p-4",children:[t.jsx("p",{className:"text-sm opacity-90",children:"NOW PLAYING"}),t.jsxs("h2",{className:"text-2xl font-bold truncate",children:[g?.number?`#${g.number} `:"",g?.name||"Select a channel"]})]}),t.jsx($,{channel:g,isLoading:k,onCanPlay:re,onError:se})]}),t.jsxs("div",{className:"md:col-span-1",children:[t.jsxs("div",{className:"flex flex-wrap gap-3 mb-6 justify-center",children:[t.jsx("input",{type:"text",placeholder:"Search channels...",className:"flex-1 min-w-[200px] max-w-md p-3 rounded-lg bg-(--bg-secondary) text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-(--brand-color)",value:j,onChange:e=>S(e.target.value)}),t.jsx("select",{className:"p-3 rounded-lg bg-(--bg-secondary) text-white focus:outline-none focus:ring-2 focus:ring-(--brand-color)",value:C,onChange:e=>E(e.target.value),"aria-label":"Filter channels by category",children:Q.map(e=>t.jsx("option",{value:e,children:"all"===e?"All Channels":e},e))})]}),t.jsx("div",{className:"bg-(--bg-secondary) rounded-xl shadow-lg overflow-hidden",children:t.jsx("div",{className:"flex flex-col max-h-[70vh] overflow-y-auto",children:Z.length>0?Z.map(e=>{const r=f(e.url),n="online"===r?.status?"text-green-500":"offline"===r?.status?"text-red-500":"timeout"===r?.status?"text-yellow-500":"text-gray-500";return t.jsxs("div",{className:"relative",children:[t.jsxs("button",{onClick:()=>ee(e),className:`flex items-center justify-between p-4 pr-12 w-full text-left transition-colors ${e.url===g?.url?"bg-(--brand-color) text-white font-bold":"text-gray-200 hover:bg-(--bg-tertiary)"} border-b border-b-(--border-color) last:border-b-0`,children:[t.jsxs("div",{className:"flex items-center gap-4 overflow-hidden",children:[t.jsx("span",{className:"shrink-0 w-10 h-10 flex items-center justify-center rounded-lg text-xs font-bold "+(e.url===g?.url?"bg-white/20":"bg-(--bg-tertiary)"),children:"number"==typeof e.number?`#${e.number}`:"â˜…"}),t.jsxs("div",{className:"flex items-center gap-2 overflow-hidden",children:[t.jsx(y,{className:`text-xs ${n} ${"online"===r?.status?"animate-pulse":""}`}),t.jsx("span",{className:"font-semibold truncate",children:e.name}),r?.latency&&t.jsxs("span",{className:"text-xs text-gray-400 hidden lg:inline",children:[r.latency,"ms"]})]})]}),t.jsx("div",{className:"flex items-center gap-3 shrink-0",children:e.url===g?.url&&t.jsxs("div",{className:"hidden sm:flex items-center gap-1.5 text-white animate-pulse",children:[t.jsx("span",{className:"live-dot bg-white"}),t.jsx("span",{className:"text-sm font-semibold",children:"Playing"})]})})]}),t.jsx("button",{onClick:t=>{t.stopPropagation(),te(e,t)},className:"absolute top-4 right-4 text-xl p-1 z-10","aria-label":`Toggle favorite for ${e.name}`,children:t.jsx("span",{className:""+(q.includes(e.name)?"text-yellow-400":"text-gray-500 hover:text-yellow-400"),children:"â˜…"})})]},e.number||e.url)}):t.jsxs("p",{className:"p-8 text-center text-(--text-secondary)",children:["No channels found ",j?`for "${j}"`:""," ","all"!==C?`in ${C}`:"","."]})})})]})]})]}),t.jsx(K,{open:T,onClose:()=>P(!1),onSuccess:e=>{try{const t={category:"Requested",number:(r[r.length-1]?.number||0)+1,...e};o(e=>{const r=[t,...e];return localStorage.setItem("iptv_user_channels",JSON.stringify(r)),r})}catch(t){}}})]})};export{ye as IPTVPage};
